# 검색 기능 개선 사항

## 수정 일시
2026-01-14

## 주요 문제점 및 해결 방안

### 1. Perplexity API 검색 실패 문제
**문제**: JSON 파싱 오류로 검색 결과를 제대로 추출하지 못함

**해결**:
- 3단계 JSON 추출 방법 구현
  1. Direct JSON parse
  2. Regex를 이용한 JSON 배열 추출
  3. URL 패턴 매칭을 통한 수동 추출
- API 응답 디버깅 UI 추가 (expander로 raw response 확인 가능)
- 프롬프트 개선 (온도 0.1로 낮춰 일관성 향상)
- 상세한 에러 메시지 및 traceback 표시

### 2. 자동 검색 트리거 문제
**문제**: Discipline 변경 시 검색이 제대로 작동하지 않음

**해결**:
- 검색 쿼리 구체화 (ICR, official rules 키워드 추가)
- auto_search_done 플래그 적절한 리셋
- 검색 성공/실패 시 명확한 피드백 메시지

### 3. PDF 로드 실패 문제
**문제**: PDF 다운로드 및 텍스트 추출이 불안정

**해결**:
- User-Agent 헤더 추가 (봇 차단 회피)
- 타임아웃 30초로 증가
- Content-Type 검증 추가
- 페이지별 에러 핸들링 (일부 페이지 실패해도 계속 진행)
- 상세한 진행 상황 표시 (다운로드 중, 페이지 추출 중 등)
- 전체 에러 traceback 표시

### 4. 수동 검색 개선
**문제**: 수동 검색 시 쿼리 최적화 부족

**해결**:
- 자동 검색과 동일한 쿼리 최적화 로직 적용
- URL 유효성 검증 (http 시작, .pdf 포함 확인)
- 검색 결과에 대한 명확한 피드백

### 5. 폴백 메커니즘
**추가 기능**:
- `get_fallback_fis_urls()` 함수 구현 (향후 활용 가능)
- 주요 종목별 기본 ICR 문서 URL 제공

## 개선된 기능

### 검색 성능
- **정확도**: 다중 JSON 파싱 방법으로 추출 성공률 향상
- **속도**: Temperature 0.1로 더 빠르고 일관된 응답
- **신뢰성**: 3단계 fallback으로 검색 실패 최소화

### 사용자 경험
- **투명성**: 디버그 정보로 문제 진단 용이
- **피드백**: 각 단계별 명확한 상태 메시지
- **오류 처리**: 구체적인 에러 메시지 및 해결 방법 제시

## 테스트 권장 사항

1. **자동 검색 테스트**
   - 다양한 Discipline 선택 (Alpine, Cross-Country, etc.)
   - 각 종목별 문서 검색 성공 여부 확인

2. **수동 검색 테스트**
   - 유효한 PDF URL 입력
   - 잘못된 URL 입력 시 에러 처리 확인

3. **PDF 로드 테스트**
   - 다양한 크기의 PDF 문서
   - 네트워크 지연 시나리오

4. **디버깅 기능 테스트**
   - API 응답 expander 확인
   - 에러 traceback 확인

## 향후 개선 사항

1. **캐싱 강화**: 검색 결과 캐싱으로 중복 API 호출 방지
2. **오프라인 모드**: 미리 다운로드한 문서 사용
3. **검색 히스토리**: 사용자의 이전 검색 기록 저장
4. **AI 기반 문서 추천**: 사용자 질문 기반 관련 문서 자동 제안
